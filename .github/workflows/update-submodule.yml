name: Update Submodule and Deploy

on:
  schedule:
    # ë§¤ 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC 0, 6, 12, 18ì‹œ = KST 9, 15, 21, 3ì‹œ)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ê°€ëŠ¥

permissions:
  contents: write  # ì„œë¸Œëª¨ë“ˆ ì—…ë°ì´íŠ¸ ì»¤ë°‹ì„ ìœ„í•´ í•„ìš”
  pages: write
  id-token: write

concurrency:
  group: "submodule-update"
  cancel-in-progress: false

jobs:
  update-submodule:
    runs-on: ubuntu-latest
    outputs:
      submodule_updated: ${{ steps.check_changes.outputs.changed }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update submodule to latest
        run: |
          echo "ðŸ“ Current submodule commit:"
          git submodule status data/calender

          echo "ðŸ”„ Fetching latest from remote..."
          git submodule update --init --remote data/calender

          echo "ðŸ“¦ After update:"
          git submodule status data/calender

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected in submodule"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”” Submodule has been updated"
            git diff --stat
          fi

      - name: Commit and push changes
        id: commit
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git add data/calender
          git commit -m "chore: auto-update data submodule to latest

          Updated by scheduled workflow at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin main
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "âœ… Changes committed and pushed"

      - name: Log update status
        run: |
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "::notice title=Submodule Updated::Data submodule updated to latest commit. Build will start."
          else
            echo "::notice title=No Update::Data submodule is already up to date. Skipping build."
          fi

  build:
    needs: update-submodule
    if: needs.update-submodule.outputs.submodule_updated == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout updated code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.update-submodule.outputs.commit_sha }}
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build with Next.js
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
